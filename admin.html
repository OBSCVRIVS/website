<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin · Notes</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="theme-color" content="#FFFFFF">

  <!-- Minimal, page-scoped styles for layout + icon + counter -->
  <style>
    .admin-wrap { max-width: 960px; margin: 2rem auto; padding: 1rem; }
    .admin-row { display:flex; justify-content:space-between; align-items:center; gap:1rem; }
    .admin-grid2 { display:grid; gap:1rem; grid-template-columns:1fr 1fr; }
    .admin-card { border:1px solid var(--field-border); padding:1rem; border-radius:4px; background:var(--field); }
    #posts-list .tweet { border: 0; border-top: 1px solid var(--field-border); margin: 0; }
    #posts-list .tweet:first-child { border-top: 0; }
    .permalink{ color:var(--muted); text-decoration:none; display:inline-flex; align-items:center; }
    .permalink:hover,.permalink:focus{ color:var(--accent); }
    .permalink svg{ width:16px; height:16px; display:block; }
    .sr-only{ position:absolute!important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    /* Byte counter */
    .byte-row{ display:flex; justify-content:space-between; align-items:center; margin-top:.35rem; font-size:.9rem; }
    .byte-count{ font-variant-numeric: tabular-nums; }
    .ok{ color: var(--muted); }
    .warn{ color: #B26A00; }
    .bad{ color: #B00020; }
    .mini-actions{ display:flex; gap:.5rem; flex-wrap:wrap; }
    .mini-actions button{ padding:.3rem .55rem; font-size:.85rem; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.9/dist/purify.min.js" defer></script>
</head>
<body>
<main class="admin-wrap">
  <header class="admin-row">
    <h1>Admin</h1>
  </header>

  <!-- Auth -->
  <section class="admin-card" style="margin-bottom:1rem">
    <h2 style="margin-top:0">Authentication</h2>
    <div class="admin-grid2">
      <div>
        <label>
          <span class="muted">Username</span>
          <input id="username" type="text" placeholder="e.g. levi" autocomplete="username">
        </label>
        <div style="margin-top:.5rem;display:flex;gap:.5rem;flex-wrap:wrap">
          <button id="btn-register" class="btn ghost">Register Passkey</button>
          <button id="btn-login" class="btn primary">Sign in with Passkey</button>
          <button id="btn-logout" class="btn ghost">Sign out</button>
        </div>
        <div id="remembered" style="margin-top:.75rem"></div>
      </div>
      <div>
        <div class="muted">Status</div>
        <div id="auth-state">Signed out</div>
        <div id="auth-user" class="muted"></div>
      </div>
    </div>
  </section>

  <!-- Composer -->
  <section id="composer" class="admin-card" style="margin-bottom:1rem;display:none">
    <h2 style="margin-top:0">New Note</h2>
    <form id="note-form" class="admin-grid2">
      <label>
        <span>Markdown</span>
        <textarea id="body" rows="18" placeholder="Write Markdown…"></textarea>

        <!-- live byte counter + quick tools -->
        <div class="byte-row">
          <div class="mini-actions">
            <button type="button" id="btn-trim" class="btn ghost">Trim</button>
            <button type="button" id="btn-collapse" class="btn ghost">Collapse blanks</button>
          </div>
          <div class="byte-count ok">
            <span id="byte-now">0</span>/<span id="byte-max">90000</span> bytes
          </div>
        </div>
      </label>

      <section>
        <header class="muted">Preview</header>
       <div id="preview" class="admin-card" style="min-height:18rem;padding:0">
  <article class="tweet" style="border:0;margin:0">
    <div class="tweet__avatar"><img src="assets/img/avatar_anime_blue_hour.png" alt="" aria-hidden="true"></div>
    <div class="tweet__body">
      <header class="tweet__head">
        <span class="name">Levi Carver</span>
        <span class="dot" aria-hidden="true">·</span>
        <time id="preview-time" datetime=""></time>
      </header>
      <div id="preview-text" class="tweet__text"></div>
      <div class="tweet__actions" style="opacity:.6">
        <a class="permalink" href="javascript:void(0)" aria-label="Permalink (preview only)">
          <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px">
            <path d="M10.172 13.828a4 4 0 0 0 5.656 0l3-3a4 4 0 1 0-5.656-5.656l-1.172 1.172"/>
            <path d="M13.828 10.172a4 4 0 0 0-5.656 0l-3 3a4 4 0 1 0 5.656 5.656l1.172-1.172"/>
          </svg>
          <span class="sr-only">Permalink</span>
        </a>
      </div>
    </div>
  </article>
</div>
      </section>

      <div class="muted" style="grid-column:1/-1">
        Timestamp set on save (UTC ISO + your IANA time zone). 24-hour time shown on site.
      </div>
      <div>
        <button type="submit" id="btn-post" class="btn primary">Post</button>
      </div>
    </form>
  </section>

  <!-- Posts -->
  <section id="posts" class="admin-card" style="display:none">
    <div class="admin-row" style="margin-bottom:.5rem">
      <h2 style="margin:0">Posts</h2>
      <button id="btn-reload" class="btn ghost">Reload</button>
    </div>
    <div id="posts-list" class="admin-card" style="padding:0"></div>
  </section>

  <!-- Debug -->
  <section class="admin-card" style="margin-top:1rem">
    <h2 style="margin-top:0">Debug</h2>
    <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.5rem">
      <button id="dbg-ping" class="btn ghost">Ping API</button>
      <button id="dbg-session" class="btn ghost">Show Session</button>
      <button id="dbg-clear" class="btn ghost">Clear Log</button>
    </div>
    <textarea id="debug" rows="10" class="admin-card" style="width:100%;background:var(--field)"></textarea>
  </section>
</main>

<script>
/* ===== Utils ===== */
const $ = s => document.querySelector(s);
const dbg = $('#debug');
function log(...args){ if(!dbg) return; dbg.value += args.map(v=>typeof v==='string'?v:JSON.stringify(v,null,2)).join(' ') + "\n"; dbg.scrollTop = dbg.scrollHeight; }

/* ===== API, auth, preview, compose (unchanged from your last file)… ===== */
/* ... keep your existing code for api, passkeys, notesCreate, etc. ... */

/* ===== Posts (stitch chunked posts) ===== */
const postsBox = $('#posts-list');
$('#btn-reload')?.addEventListener('click', loadPosts);

function mdRender(src){
  marked.setOptions({ gfm:true, breaks:false, headerIds:true, mangle:false });
  return DOMPurify.sanitize(marked.parse(src||""), { ADD_ATTR:['target','rel'], FORBID_TAGS:['script','style'] });
}
function parseChunkMeta(body){
  const m = body.match(/^\[CHUNK\s+gid=([^\s]+)\s+idx=(\d+)\s+total=(\d+)\]/);
  return m ? { gid:m[1], idx:+m[2], total:+m[3] } : null;
}
function stripChunkMeta(body){ return body.replace(/^\[CHUNK[^\]]+\]\s*\n?/, ''); }

function stitchNotes(raw){
  const groups = new Map(); const singles = [];
  for(const n of raw||[]){
    const meta = parseChunkMeta(n.body||'');
    if(!meta){ singles.push({id:n.id,ids:[n.id],created_at:n.created_at,tz:n.tz,body:n.body}); continue; }
    if(!groups.has(meta.gid)) groups.set(meta.gid,{gid:meta.gid,total:meta.total,chunks:[]});
    groups.get(meta.gid).chunks.push({id:n.id,idx:meta.idx,created_at:n.created_at,tz:n.tz,body:stripChunkMeta(n.body||'')});
  }
  const stitched=[];
  for(const g of groups.values()){
    g.chunks.sort((a,b)=>a.idx-b.idx);
    const body=g.chunks.map(c=>c.body).join('\n\n');
    stitched.push({id:g.chunks[0].id,ids:g.chunks.map(c=>c.id),created_at:g.chunks[0].created_at,tz:g.chunks[0].tz,body});
  }
  return [...singles,...stitched].sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
}

function renderPosts(notes){
  if(!postsBox) return;
  const display=stitchNotes(notes);
  if(!display.length){ postsBox.innerHTML='<div class="muted" style="padding:1rem">No posts.</div>'; return; }
  postsBox.innerHTML=display.map(n=>{
    const when=fmtLocal(n.created_at,n.tz);
    const multi=n.ids.length>1;
    return `
      <article class="tweet" id="${n.id}" style="padding:1rem;border-top:1px solid var(--field-border)">
        <div style="display:flex;gap:1rem">
          <div class="tweet__avatar"><img src="assets/img/avatar_anime_blue_hour.png" alt="" aria-hidden="true"></div>
          <div class="tweet__body" style="flex:2">
            <header class="tweet__head">
              <span class="name">Levi Carver</span>
              <span class="dot" aria-hidden="true">·</span>
              <time datetime="${n.created_at}">${when}</time>
              ${multi?'<span class="dot" aria-hidden="true">·</span><span class="muted">stitched</span>': ''}
            </header>
            <div class="tweet__text">${mdRender(n.body)}</div>
          </div>
          <div style="flex:1;display:flex;justify-content:flex-end;align-items:flex-start;gap:.5rem">
            <a class="permalink" href="/notes.html?id=${encodeURIComponent(n.id)}" aria-label="Permalink">
              <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px">
                <path d="M10.172 13.828a4 4 0 0 0 5.656 0l3-3a4 4 0 1 0-5.656-5.656l-1.172 1.172"/>
                <path d="M13.828 10.172a4 4 0 0 0-5.656 0l-3 3a4 4 0 1 0 5.656 5.656l1.172-1.172"/>
              </svg>
              <span class="sr-only">Permalink</span>
            </a>
            <button class="btn ghost" data-act="delete-post" data-ids='${JSON.stringify(n.ids)}'>Delete</button>
          </div>
        </div>
      </article>`;
  }).join('');
  postsBox.querySelectorAll('.tweet__text a').forEach(a=>{a.target='_blank';a.rel='noopener noreferrer';});
  postsBox.querySelectorAll('button[data-act="delete-post"]').forEach(b=>{
    b.addEventListener('click',async()=>{
      const ids=JSON.parse(b.getAttribute('data-ids')||'[]');
      if(!ids.length) return;
      if(!confirm(ids.length>1?`Delete this stitched post and all ${ids.length} chunks?`:`Delete this post?`)) return;
      try{ for(const id of ids){ await notesDelete(id);} await loadPosts(); }
      catch(e){ log('delete error →',e?.message||e); alert('Failed to delete'); }
    });
  });
}

async function loadPosts(){
  try{ const notes=await notesList(); window.__NOTES=Array.isArray(notes)?notes:[]; renderPosts(window.__NOTES);}
  catch(e){ log('load posts error →',e?.message||e); postsBox.innerHTML='<div class="muted" style="padding:1rem">Could not load posts.</div>'; }
}
</script>
</body>
</html>
