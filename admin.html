<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin · New Note</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="theme-color" content="#FFFFFF">

  <script>
    (function(){
      var t = localStorage.getItem('theme') || 'auto';
      var initial = (t==='light'||t==='dark')
        ? t
        : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', initial);
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.9/dist/purify.min.js" defer></script>
</head>
<body>
<main class="container">
  <header class="flex-between">
    <h1>New Note</h1>
    <label class="muted">
      Theme:
      <select id="theme-select">
        <option value="auto">Auto (sunrise/sunset)</option>
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>
    </label>
  </header>

  <form id="note-form" class="grid-2">
    <label>
      <span>Markdown</span>
      <textarea id="body" rows="22" placeholder="Write Markdown…"></textarea>
    </label>

    <section>
      <header class="muted">Preview</header>
      <article id="preview" class="tweet__text card"></article>
    </section>

    <label>
      <span class="muted">Created at</span>
      <input id="created_at" type="datetime-local">
    </label>

    <div>
      <button type="submit" class="btn primary">Save</button>
    </div>
  </form>
</main>

<script>
  // Markdown preview
  const bodyEl = document.getElementById('body');
  const previewEl = document.getElementById('preview');
  function renderPreview(){
    marked.setOptions({ gfm:true, breaks:false, headerIds:true, mangle:false });
    const html = marked.parse(bodyEl.value || "");
    previewEl.innerHTML = DOMPurify.sanitize(html, {
      ADD_ATTR:['target','rel'],
      FORBID_TAGS:['script','style']
    });
    previewEl.querySelectorAll('a').forEach(a=>{ a.target='_blank'; a.rel='noopener noreferrer'; });
  }
  bodyEl.addEventListener('input', renderPreview);
  document.addEventListener('DOMContentLoaded', renderPreview);

  // Example submit (replace with your API)
  document.getElementById('note-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const payload = {
      body: bodyEl.value,
      created_at: new Date(document.getElementById('created_at').value || Date.now()).toISOString()
    };
    // Replace with your endpoint:
    // await fetch('/api/notes', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    alert('Would POST:\n' + JSON.stringify(payload, null, 2));
  });

  // Theme engine (same as site)
  (function () {
    const CONFIG = { lat: 34.0522, lon: -118.2437 };
    const STORAGE_KEY = "theme";
    const selectEl = document.getElementById("theme-select");

    function sunTimes(date, lat, lon) {
      const rad = Math.PI/180, dayMs = 86400000;
      const dateUTC = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate());
      const J2000 = 946684800000;
      const n = Math.round(((dateUTC - J2000)/dayMs) - (lon/360));
      const Jstar = n + lon/360 + 0.0008 + (2440587.5 - 2451545);
      function solNoon(){
        const M = (357.5291 + 0.98560028 * (Jstar - 2451545)) % 360;
        const C = 1.9148*Math.sin(M*rad) + 0.0200*Math.sin(2*M*rad) + 0.0003*Math.sin(3*M*rad);
        const L = (M + 102.9372 + C + 180) % 360;
        return 2451545 + Jstar + 0.0053*Math.sin(M*rad) - 0.0069*Math.sin(2*L*rad);
      }
      function hourAngle(){
        const M = (357.5291 + 0.98560028 * (Jstar - 2451545)) % 360;
        const C = 1.9148*Math.sin(M*rad) + 0.0200*Math.sin(2*M*rad) + 0.0003*Math.sin(3*M*rad);
        const L = (M + 102.9372 + C + 180) % 360;
        const δ = Math.asin(Math.sin(L*rad)*Math.sin(23.44*rad));
        const φ = lat*rad, h0 = (-6)*rad;
        const cosH = (Math.sin(h0) - Math.sin(φ)*Math.sin(δ)) / (Math.cos(φ)*Math.cos(δ));
        if (cosH <= -1) return Math.PI; if (cosH >= 1) return 0; return Math.acos(cosH);
      }
      function jdToDate(jd){ return new Date((jd - 2440587.5)*dayMs); }
      const Jnoon = solNoon();
      const H = hourAngle();
      const Jrise = Jnoon - (H/(2*Math.PI));
      const Jset  = Jnoon + (H/(2*Math.PI));
      return { sunrise: jdToDate(Jrise), sunset: jdToDate(Jset) };
    }

    function isNightNow(lat, lon){
      const now = new Date();
      const { sunrise, sunset } = sunTimes(now, lat, lon);
      return (now < sunrise) || (now > sunset);
    }
    function systemPrefersDark(){
      return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    }
    function applyTheme(theme){
      const html = document.documentElement;
      let resolved = theme;
      if (theme === "auto") {
        try { resolved = isNightNow(CONFIG.lat, CONFIG.lon) ? "dark" : "light"; }
        catch { resolved = systemPrefersDark() ? "dark" : "light"; }
      }
      html.setAttribute("data-theme", resolved);
      const bg = getComputedStyle(html).getPropertyValue("--bg").trim();
      let meta = document.querySelector('meta[name="theme-color"]');
      if (!meta) { meta = document.createElement("meta"); meta.name = "theme-color"; document.head.appendChild(meta); }
      meta.setAttribute("content", bg);
    }

    const saved = localStorage.getItem(STORAGE_KEY) || "auto";
    applyTheme(saved);
    if (selectEl) selectEl.value = saved;

    if (window.matchMedia) {
      window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
        if ((localStorage.getItem(STORAGE_KEY) || "auto") === "auto") applyTheme("auto");
      });
    }
    setInterval(() => {
      if ((localStorage.getItem(STORAGE_KEY) || "auto") === "auto") applyTheme("auto");
    }, 60*60*1000);

    if (selectEl) {
      selectEl.addEventListener("change", (e) => {
        const value = e.target.value;
        localStorage.setItem(STORAGE_KEY, value);
        applyTheme(value);
      });
    }
    window.Theme = { get: () => localStorage.getItem(STORAGE_KEY) || "auto",
                     set: (mode) => { localStorage.setItem(STORAGE_KEY, mode); applyTheme(mode); } };
  })();
</script>
</body>
</html>
