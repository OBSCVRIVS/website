<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Note · Levi Carver</title>
  <link rel="stylesheet" href="/styles.css">
  <meta name="theme-color" content="#FFFFFF">
  <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.9/dist/purify.min.js" defer></script>

  <!-- Page-scoped styles for the framed note + close button -->
  <style>
    .note-page{
      background: var(--field);
      border: 1px solid var(--field-border);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 2rem auto;
      max-width: 720px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      position: relative;
    }
    .note-close{
      background: none;
      border: none;
      color: var(--muted);
      font-size: 1.25rem;
      line-height: 1;
      cursor: pointer;
      position: absolute;
      top: .75rem;
      right: .75rem;
      padding: .25rem;
      border-radius: 50%;
      transition: background .2s, color .2s;
    }
    .note-close:hover,.note-close:focus{
      background: rgba(0,0,0,0.05);
      color: var(--accent);
      outline: none;
    }
  </style>
</head>
<body>
  <!-- Top nav -->
  <nav class="site-nav site-nav--top" aria-label="Site">
    <div class="site-nav__inner">
      <a class="brand" href="/">Levi Carver</a>
      <div>
        <a class="nav-link" href="/">Notes</a>
        <a class="nav-link" href="/about.html">About</a>
        <a class="nav-link" href="/contact.html">Contact</a>
      </div>
    </div>
  </nav>

  <!-- Single note, framed -->
  <main>
    <section class="note-page">
      <article id="note" class="tweet" aria-live="polite" style="cursor:auto"></article>
      <button class="note-close" id="close-btn" aria-label="Close and return to feed">✕</button>
    </section>
  </main>

  <footer class="footer" role="contentinfo">
    <small>© 2025 Levi Carver · <a href="/contact.html">Contact</a></small>
  </footer>

<script>
(function(){
  // Theme by local clock
  const LIGHT_START_H=7, LIGHT_END_H=19;
  function applyTheme(){
    const h = new Date().getHours();
    document.documentElement.setAttribute('data-theme', (h>=LIGHT_START_H && h<LIGHT_END_H) ? 'light' : 'dark');
    const bg = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim();
    let meta = document.querySelector('meta[name="theme-color"]');
    if (!meta) { meta = document.createElement('meta'); meta.name='theme-color'; document.head.appendChild(meta); }
    meta.setAttribute('content', bg);
  }
  applyTheme(); setInterval(applyTheme, 15*60*1000);

  const $ = s => document.querySelector(s);
  function fmtTime(iso,tz){
    const d=new Date(iso), zone=tz||Intl.DateTimeFormat().resolvedOptions().timeZone;
    const ds=d.toLocaleString(undefined,{month:'short',day:'numeric'});
    const ts=d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit',hour12:false,timeZone:zone});
    const tzLabel=new Intl.DateTimeFormat(undefined,{timeZoneName:'short',timeZone:zone}).formatToParts(d).find(p=>p.type==='timeZoneName')?.value||zone;
    return `${ds} · ${ts} ${tzLabel}`;
  }
  function md(src){
    marked.setOptions({ gfm:true, headerIds:true, mangle:false });
    return DOMPurify.sanitize(marked.parse(src||""), { ADD_ATTR:['target','rel'], FORBID_TAGS:['script','style'] });
  }

  // id from ?id= or /notes/<id>
  const params = new URLSearchParams(location.search);
  let id = params.get('id');
  if(!id){ const m = location.pathname.match(/\/notes\/([^/?#]+)/); if(m) id=decodeURIComponent(m[1]); }
  const noteBox = $('#note');
  const closeBtn = $('#close-btn');

  async function fetchNote(noteId){
    try{
      const r=await fetch('/api/notes/'+encodeURIComponent(noteId),{headers:{Accept:'application/json'}});
      if(r.ok) return await r.json();
    }catch{}
    const r=await fetch('/api/notes',{headers:{Accept:'application/json'}});
    if(!r.ok) throw new Error('Load failed');
    const all=await r.json();
    return all.find(n=>n.id===noteId)||null;
  }

  async function fetchAllNotes(){
    const r=await fetch('/api/notes',{headers:{Accept:'application/json'}});
    if(!r.ok) return [];
    return await r.json();
  }

  function stitchChunks(rawNotes, targetId){
    // find if targetId belongs to a chunk group
    const target = rawNotes.find(n=>n.id===targetId);
    if(!target) return null;

    const m = target.body.match(/^\[CHUNK gid=(\S+) idx=(\d+) total=(\d+)\]/);
    if(!m) return target;

    const gid = m[1], total = parseInt(m[3],10);
    const group = rawNotes.filter(n=>n.body.startsWith(`[CHUNK gid=${gid}`));
    if(group.length < total) return target; // incomplete

    // order by idx
    const parts = [];
    group.forEach(n=>{
      const mm = n.body.match(/^\[CHUNK gid=(\S+) idx=(\d+) total=(\d+)\]\n?/);
      if(mm){
        const idx = parseInt(mm[2],10);
        parts[idx-1] = n.body.replace(mm[0],'');
      }
    });
    return { ...target, body: parts.join("\n\n") };
  }

  // Smart close
  function smartClose(){
    const sameOriginRef = document.referrer && (()=>{ try{ return new URL(document.referrer).origin===location.origin; }catch{ return false; }})();
    if (sameOriginRef) { history.back(); } else { location.href = '/'; }
  }

  (async()=>{
    if(!id){ noteBox.innerHTML='<p class="muted">No note id provided.</p>'; return; }
    try{
      const all = await fetchAllNotes();
      const stitched = stitchChunks(all,id);
      if(!stitched){ noteBox.innerHTML='<p class="muted">Note not found.</p>'; return; }
      noteBox.innerHTML=`
        <div class="tweet__avatar"><img src="/assets/img/avatar_anime_blue_hour.png" alt="" aria-hidden="true" style="width:48px;height:48px;border-radius:50%"></div>
        <div class="tweet__body">
          <header class="tweet__head">
            <span class="name">Levi Carver</span>
            <span class="dot" aria-hidden="true">·</span>
            <time datetime="${stitched.created_at}">${fmtTime(stitched.created_at,stitched.tz)}</time>
          </header>
          <div class="tweet__text">${md(stitched.body)}</div>
          <div class="tweet__actions">
            <a class="permalink" href="/notes.html?id=${encodeURIComponent(stitched.id)}" aria-label="Permalink">
              <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px;height:18px;vertical-align:-2px;">
                <path d="M10.172 13.828a4 4 0 0 0 5.656 0l3-3a4 4 0 1 0-5.656-5.656l-1.172 1.172"/>
                <path d="M13.828 10.172a4 4 0 0 0-5.656 0l-3 3a4 4 0 1 0 5.656 5.656l1.172-1.172"/>
              </svg>
              <span class="sr-only">Permalink</span>
            </a>
          </div>
        </div>`;
      document.title='Note · Levi Carver';
      noteBox.querySelectorAll('.tweet__text a').forEach(a=>{ a.target='_blank'; a.rel='noopener noreferrer'; });
    }catch{
      noteBox.innerHTML='<p class="muted">Could not load this note.</p>';
    }
  })();

  closeBtn.addEventListener('click', smartClose);
})();
</script>
</body>
</html>
