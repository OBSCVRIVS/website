<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Levi Carver</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="theme-color" content="#FFFFFF">

  <!-- Reduce flash: set initial theme before paint -->
  <script>
    (function(){
      var t = localStorage.getItem('theme') || 'auto';
      var initial = (t==='light'||t==='dark')
        ? t
        : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', initial);
    })();
  </script>

  <!-- Markdown + Sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.9/dist/purify.min.js" defer></script>
</head>
<body>
<header class="banner" role="banner" aria-label="Site banner">
  <img src="assets/img/banner_blue_hour.png" alt="Blue hour banner">
</header>

<nav class="site-nav" aria-label="Site">
  <div class="site-nav__inner">
    <a class="brand" href="/">Levi Carver</a>
    <a class="nav-link" href="contact.html">Contact</a>
  </div>
</nav>

<main id="main">
  <!-- HERO -->
  <section class="hero" aria-labelledby="hero-title">
    <img class="avatar" src="assets/img/avatar_anime_blue_hour.png" alt="Portrait of Levi">
    <div class="hero-meta">
      <h1 id="hero-title">Levi Carver</h1>
      <p class="tagline">Technical Product Specialist · Los Angeles, California, USA</p>
      <nav class="social" aria-label="Social">
        <ul>
          <li><a href="https://linkedin.com/in/levicarver" rel="me noopener" target="_blank">LinkedIn</a></li>
          <li><a href="https://github.com/USERNAME" rel="me noopener" target="_blank">GitHub</a></li>
        </ul>
      </nav>
    </div>
  </section>

  <!-- ABOUT (clamped with toggle) -->
  <section class="about" aria-labelledby="about-title">
    <h2 id="about-title">About</h2>
    <p id="about-text" class="clamp-3">
      I work in tech with a focus on improving digital systems and making them more accessible for everyone.
      I value empathy, open communication, and learning from different perspectives, which guide how I approach challenges both professionally and personally.
      I’m passionate about debate, political news, and strategy games like chess, all of which push me to think critically and see issues from multiple angles.
      At the core of everything I do is a desire to understand people’s experiences and use that understanding to help create meaningful change.
    </p>
    <button id="about-toggle" class="linklike" aria-expanded="false" aria-controls="about-text">more…</button>
  </section>

  <!-- NOTES (tweet-style) -->
  <section class="feed" aria-labelledby="feed-title">
    <h2 id="feed-title">Notes</h2>
    <div id="notes"></div>
    <nav class="pager" aria-label="Pagination">
      <button id="newer" disabled>Newer</button>
      <button id="older" disabled>Older</button>
    </nav>
  </section>
</main>

<footer class="footer" role="contentinfo">
  <small>© 2025 Levi Carver · <a href="contact.html">Contact</a></small>

  <!-- Theme control (owner override) -->
  <label class="muted" style="display:inline-flex;gap:.5rem;align-items:center;margin-left:1rem">
    Theme:
    <select id="theme-select">
      <option value="auto">Auto (sunrise/sunset)</option>
      <option value="light">Light</option>
      <option value="dark">Dark</option>
    </select>
  </label>
</footer>

<script>
  // ===== Markdown helper =====
  window.MD = {
    parse(md){
      marked.setOptions({ gfm:true, breaks:false, headerIds:true, mangle:false });
      const html = marked.parse(md || "");
      return DOMPurify.sanitize(html, {
        ADD_ATTR:['target','rel'],
        FORBID_TAGS:['script','style']
      });
    }
  };

  // ===== About expand/collapse =====
  (function () {
    const text = document.getElementById('about-text');
    const btn = document.getElementById('about-toggle');
    btn.addEventListener('click', () => {
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', String(!expanded));
      text.classList.toggle('clamp-3', expanded);
      btn.textContent = expanded ? 'more…' : 'less';
      if (!expanded) text.classList.remove('clamp-3');
    });
  }());

  // ===== Notes render (from /api/notes) with Markdown =====
  (async function () {
    const pageSize = 10;
    let page = 0;
    const container = document.getElementById('notes');
    const newer = document.getElementById('newer');
    const older = document.getElementById('older');
    let notes = [];

    // 24-hour time + TZ label
    function fmtTime(iso, tz){
      const d = new Date(iso);
      const zone = tz || Intl.DateTimeFormat().resolvedOptions().timeZone;
      const ds = d.toLocaleString(undefined, { month:'short', day:'numeric' });
      const ts = d.toLocaleTimeString(undefined, { hour:'2-digit', minute:'2-digit', hour12:false, timeZone: zone });
      const tzLabel = new Intl.DateTimeFormat(undefined, { timeZoneName:'short', timeZone: zone })
        .formatToParts(d).find(p=>p.type==='timeZoneName')?.value || zone;
      return `${ds} · ${ts} ${tzLabel}`;
    }

    async function load(){
      try {
        const r = await fetch('/api/notes', { headers: { 'Accept':'application/json' } });
        if (!r.ok) throw new Error('Failed to fetch notes');
        notes = await r.json();
        render();
      } catch {
        container.innerHTML = '<p class="muted">Could not load notes.</p>';
      }
    }

    function render(){
      container.innerHTML = '';
      const start = page * pageSize;
      const slice = notes.slice(start, start + pageSize);
      slice.forEach(n => {
        const card = document.createElement('article');
        card.className = 'tweet';
        card.id = n.id;

        card.innerHTML = `
          <div class="tweet__avatar"><img src="assets/img/avatar_anime_blue_hour.png" alt="" aria-hidden="true"></div>
          <div class="tweet__body">
            <header class="tweet__head">
              <span class="name">Levi Carver</span>
              <span class="dot" aria-hidden="true">·</span>
              <time datetime="${n.created_at}">${fmtTime(n.created_at, n.tz)}</time>
            </header>
            <div class="tweet__text">${MD.parse(n.body)}</div>
            <div class="tweet__actions">
              <a class="permalink" href="notes/${n.id}" aria-label="Permalink">Permalink</a>
            </div>
          </div>
        `;

        // Expand/collapse card on background click
        card.addEventListener('click', (ev) => {
          if (ev.target.closest('a,button')) return;
          card.classList.toggle('expanded');
        });

        container.appendChild(card);
      });

      // Make links safe
      container.querySelectorAll('.tweet__text a').forEach(a=>{
        a.target = '_blank'; a.rel = 'noopener noreferrer';
      });

      newer.disabled = page === 0;
      older.disabled = (start + pageSize) >= notes.length;
    }

    newer.addEventListener('click', ()=>{ if(page>0){ page--; render(); }});
    older.addEventListener('click', ()=>{ if((page+1)*pageSize < notes.length){ page++; render(); }});

    await load();
  }());

  // ===== Theme engine: auto by sunrise/sunset, override via select =====
  (function () {
    const CONFIG = { lat: 34.0522, lon: -118.2437 }; // LA
    const STORAGE_KEY = "theme";
    const selectEl = document.getElementById("theme-select");

    function sunTimes(date, lat, lon) {
      const rad = Math.PI/180, dayMs = 86400000;
      const dateUTC = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate());
      const J2000 = 946684800000;
      const n = Math.round(((dateUTC - J2000)/dayMs) - (lon/360));
      const Jstar = n + lon/360 + 0.0008 + (2440587.5 - 2451545);
      function solNoon(){
        const M = (357.5291 + 0.98560028 * (Jstar - 2451545)) % 360;
        const C = 1.9148*Math.sin(M*rad) + 0.0200*Math.sin(2*M*rad) + 0.0003*Math.sin(3*M*rad);
        const L = (M + 102.9372 + C + 180) % 360;
        return 2451545 + Jstar + 0.0053*Math.sin(M*rad) - 0.0069*Math.sin(2*L*rad);
      }
      function hourAngle(){
        const M = (357.5291 + 0.98560028 * (Jstar - 2451545)) % 360;
        const C = 1.9148*Math.sin(M*rad) + 0.0200*Math.sin(2*M*rad) + 0.0003*Math.sin(3*M*rad);
        const L = (M + 102.9372 + C + 180) % 360;
        const δ = Math.asin(Math.sin(L*rad)*Math.sin(23.44*rad));
        const φ = lat*rad, h0 = (-6)*rad;
        const cosH = (Math.sin(h0) - Math.sin(φ)*Math.sin(δ)) / (Math.cos(φ)*Math.cos(δ));
        if (cosH <= -1) return Math.PI; if (cosH >= 1) return 0; return Math.acos(cosH);
      }
      function jdToDate(jd){ return new Date((jd - 2440587.5)*dayMs); }
      const Jnoon = solNoon();
      const H = hourAngle();
      const Jrise = Jnoon - (H/(2*Math.PI));
      const Jset  = Jnoon + (H/(2*Math.PI));
      return { sunrise: jdToDate(Jrise), sunset: jdToDate(Jset) };
    }

    function isNightNow(lat, lon){
      const now = new Date();
      const { sunrise, sunset } = sunTimes(now, lat, lon);
      return (now < sunrise) || (now > sunset);
    }
    function systemPrefersDark(){
      return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    }
    function applyTheme(theme){
      const html = document.documentElement;
      let resolved = theme;
      if (theme === "auto") {
        try { resolved = isNightNow(CONFIG.lat, CONFIG.lon) ? "dark" : "light"; }
        catch { resolved = systemPrefersDark() ? "dark" : "light"; }
      }
      html.setAttribute("data-theme", resolved);
      const bg = getComputedStyle(html).getPropertyValue("--bg").trim();
      let meta = document.querySelector('meta[name="theme-color"]');
      if (!meta) { meta = document.createElement("meta"); meta.name = "theme-color"; document.head.appendChild(meta); }
      meta.setAttribute("content", bg);
    }

    const saved = localStorage.getItem(STORAGE_KEY) || "auto";
    applyTheme(saved);
    if (selectEl) selectEl.value = saved;

    if (window.matchMedia) {
      window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
        if ((localStorage.getItem(STORAGE_KEY) || "auto") === "auto") applyTheme("auto");
      });
    }
    setInterval(() => {
      if ((localStorage.getItem(STORAGE_KEY) || "auto") === "auto") applyTheme("auto");
    }, 60*60*1000);

    if (selectEl) {
      selectEl.addEventListener("change", (e) => {
        const value = e.target.value;
        localStorage.setItem(STORAGE_KEY, value);
        applyTheme(value);
      });
    }

    // Programmatic control if needed:
    window.Theme = { get: () => localStorage.getItem(STORAGE_KEY) || "auto",
                     set: (mode) => { localStorage.setItem(STORAGE_KEY, mode); applyTheme(mode); } };
  })();
</script>
</body>
</html>
